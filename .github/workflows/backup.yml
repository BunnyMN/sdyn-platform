name: Scheduled Backup

on:
  schedule:
    # Run daily at 02:00 UTC (10:00 Mongolia time)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - database
          - files

env:
  SERVER_HOST: 206.189.146.159
  SERVER_USER: root
  PROJECT_PATH: /home/sdyn/sdyn-platform
  BACKUP_PATH: /home/sdyn/backups

jobs:
  backup:
    name: Create Backup
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup directory
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            mkdir -p ${{ env.BACKUP_PATH }}
            mkdir -p ${{ env.BACKUP_PATH }}/daily
            mkdir -p ${{ env.BACKUP_PATH }}/weekly
          ENDSSH

      - name: Backup PostgreSQL
        if: github.event.inputs.backup_type != 'files'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="${{ env.BACKUP_PATH }}/daily/postgres_${DATE}.sql.gz"

            echo "Creating PostgreSQL backup..."
            docker exec sdyn-postgres pg_dumpall -U sdyn_user | gzip > "$BACKUP_FILE"

            # Check backup size
            ls -lh "$BACKUP_FILE"

            echo "PostgreSQL backup completed: $BACKUP_FILE"
          ENDSSH

      - name: Backup MinIO data
        if: github.event.inputs.backup_type == 'full' || github.event.inputs.backup_type == 'files' || github.event.inputs.backup_type == ''
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="${{ env.BACKUP_PATH }}/daily/minio_${DATE}.tar.gz"

            echo "Creating MinIO backup..."
            docker run --rm \
              --volumes-from sdyn-minio \
              -v ${{ env.BACKUP_PATH }}/daily:/backup \
              alpine tar czf "/backup/minio_${DATE}.tar.gz" /data 2>/dev/null || true

            ls -lh "$BACKUP_FILE" 2>/dev/null || echo "MinIO backup skipped (no data)"
          ENDSSH

      - name: Backup environment files
        if: github.event.inputs.backup_type == 'full' || github.event.inputs.backup_type == ''
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="${{ env.BACKUP_PATH }}/daily/env_${DATE}.tar.gz"

            echo "Creating environment backup..."
            tar czf "$BACKUP_FILE" \
              -C ${{ env.PROJECT_PATH }} \
              .env traefik/acme.json 2>/dev/null || true

            ls -lh "$BACKUP_FILE"
          ENDSSH

      - name: Cleanup old backups
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            echo "Cleaning up old backups (older than 7 days)..."
            find ${{ env.BACKUP_PATH }}/daily -name "*.gz" -mtime +7 -delete
            find ${{ env.BACKUP_PATH }}/daily -name "*.tar.gz" -mtime +7 -delete

            echo "Current backups:"
            ls -lh ${{ env.BACKUP_PATH }}/daily/ | tail -20
          ENDSSH

      - name: Create weekly backup (Sundays)
        if: github.event.schedule != '' && contains('0', format('{0}', github.event.schedule))
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            # Check if today is Sunday
            if [ $(date +%u) -eq 7 ]; then
              DATE=$(date +%Y%m%d)
              echo "Creating weekly backup..."

              # Copy latest daily backup to weekly
              LATEST_PG=$(ls -t ${{ env.BACKUP_PATH }}/daily/postgres_*.gz 2>/dev/null | head -1)
              if [ -n "$LATEST_PG" ]; then
                cp "$LATEST_PG" "${{ env.BACKUP_PATH }}/weekly/postgres_weekly_${DATE}.sql.gz"
              fi

              # Cleanup weekly backups older than 30 days
              find ${{ env.BACKUP_PATH }}/weekly -name "*.gz" -mtime +30 -delete
            fi
          ENDSSH

      - name: Report backup status
        run: |
          echo "## Backup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH' >> $GITHUB_STEP_SUMMARY
            echo "### Daily Backups"
            echo "\`\`\`"
            ls -lh ${{ env.BACKUP_PATH }}/daily/ 2>/dev/null | tail -10
            echo "\`\`\`"
            echo ""
            echo "### Disk Usage"
            echo "\`\`\`"
            du -sh ${{ env.BACKUP_PATH }}/*
            echo "\`\`\`"
          ENDSSH
