name: Database Operations

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Database operation'
        required: true
        type: choice
        options:
          - migrate-up
          - migrate-down
          - migrate-status
          - backup
          - seed
      steps:
        description: 'Number of migration steps (for migrate-down)'
        required: false
        default: '1'

env:
  SERVER_HOST: 206.189.146.159
  SERVER_USER: root
  PROJECT_PATH: /home/sdyn/sdyn-platform

jobs:
  database-operation:
    name: Database Operation
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Pre-operation backup
        if: github.event.inputs.operation == 'migrate-up' || github.event.inputs.operation == 'migrate-down'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            DATE=$(date +%Y%m%d_%H%M%S)
            echo "Creating pre-migration backup..."
            docker exec sdyn-postgres pg_dumpall -U sdyn_user | gzip > /home/sdyn/backups/pre_migration_${DATE}.sql.gz
            ls -lh /home/sdyn/backups/pre_migration_${DATE}.sql.gz
          ENDSSH

      - name: Run migrate up
        if: github.event.inputs.operation == 'migrate-up'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }}
            echo "Running migrations up..."
            docker exec sdyn-backend /app/migrate up
            echo "Migration completed!"
          ENDSSH

      - name: Run migrate down
        if: github.event.inputs.operation == 'migrate-down'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }}
            echo "Running migrations down (${{ github.event.inputs.steps }} steps)..."
            docker exec sdyn-backend /app/migrate down ${{ github.event.inputs.steps }}
            echo "Migration rollback completed!"
          ENDSSH

      - name: Check migration status
        if: github.event.inputs.operation == 'migrate-status'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }}
            echo "Checking migration status..."
            docker exec sdyn-backend /app/migrate version
            echo ""
            echo "Database tables:"
            docker exec sdyn-postgres psql -U sdyn_user -d sdyn_db -c "\dt"
          ENDSSH

      - name: Create backup
        if: github.event.inputs.operation == 'backup'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="/home/sdyn/backups/manual_${DATE}.sql.gz"
            echo "Creating manual backup..."
            docker exec sdyn-postgres pg_dumpall -U sdyn_user | gzip > "$BACKUP_FILE"
            ls -lh "$BACKUP_FILE"
            echo "Backup completed: $BACKUP_FILE"
          ENDSSH

      - name: Run seed
        if: github.event.inputs.operation == 'seed'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.PROJECT_PATH }}
            echo "Running database seed..."
            docker exec sdyn-backend /app/seed
            echo "Seed completed!"
          ENDSSH

      - name: Verify database
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            echo "Verifying database connection..."
            docker exec sdyn-postgres pg_isready -U sdyn_user -d sdyn_db
            echo ""
            echo "Table counts:"
            docker exec sdyn-postgres psql -U sdyn_user -d sdyn_db -c "
              SELECT schemaname, relname, n_live_tup
              FROM pg_stat_user_tables
              ORDER BY n_live_tup DESC;
            "
          ENDSSH

      - name: Report results
        run: |
          echo "## Database Operation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Operation:** ${{ github.event.inputs.operation }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
