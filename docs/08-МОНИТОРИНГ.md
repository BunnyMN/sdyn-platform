# СДЗН Платформ - Мониторинг

## Ерөнхий мэдээлэл

Системийн мониторинг дараах бүрэлдэхүүнүүдээс бүрдэнэ:

| Бүрэлдэхүүн | Үүрэг | URL |
|-------------|-------|-----|
| Prometheus | Metrics цуглуулах | Дотоод :9090 |
| Grafana | Dashboard, Alert | https://grafana.e-sdy.mn |
| Loki | Log цуглуулах | Дотоод :3100 |
| Promtail | Log илгээх | - |
| Node Exporter | Системийн metrics | Дотоод :9100 |

## Grafana

### Нэвтрэх
- **URL**: https://grafana.e-sdy.mn
- **Username**: admin
- **Password**: .env файлаас `GRAFANA_ADMIN_PASSWORD`

### Dashboard-ууд

#### 1. System Overview
Серверийн ерөнхий мэдээлэл:
- CPU хэрэглээ
- Memory хэрэглээ
- Disk хэрэглээ
- Network traffic

#### 2. Docker Containers
Container-уудын статус:
- Container status (up/down)
- CPU per container
- Memory per container
- Network per container

#### 3. Application Metrics
Аппликешны metrics:
- Request rate
- Response time
- Error rate
- Active users

#### 4. Database Metrics
PostgreSQL metrics:
- Connections
- Query time
- Cache hit ratio
- Database size

### Dashboard импортлох

1. Grafana > Dashboards > Import
2. Dashboard ID оруулах:
   - Node Exporter: 1860
   - Docker: 893
   - PostgreSQL: 9628
3. Data source сонгох
4. Import дарах

### Alert үүсгэх

1. Alerting > Alert Rules > New alert rule
2. Query тохируулах:
```promql
# CPU > 80%
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80

# Memory > 85%
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85

# Disk > 90%
(1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
```

3. Alert conditions тохируулах
4. Notification channel сонгох
5. Save дарах

### Notification Channels

#### Email
1. Alerting > Contact points > New contact point
2. Type: Email
3. Addresses: admin@e-sdy.mn
4. Save дарах

#### Slack
1. Alerting > Contact points > New contact point
2. Type: Slack
3. Webhook URL: https://hooks.slack.com/...
4. Channel: #alerts
5. Save дарах

## Prometheus

### Metrics endpoint-ууд

| Service | Endpoint |
|---------|----------|
| Node Exporter | http://node-exporter:9100/metrics |
| Traefik | http://traefik:8080/metrics |
| Backend | http://backend:8080/metrics (хэрэв нэмсэн бол) |

### PromQL жишээ

```promql
# CPU хэрэглээ
100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# Memory хэрэглээ
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

# Disk хэрэглээ
100 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} * 100)

# HTTP request rate
sum(rate(traefik_service_requests_total[5m]))

# HTTP error rate
sum(rate(traefik_service_requests_total{code=~"5.."}[5m]))

# Response time (p95)
histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le, service))
```

### Prometheus config

`monitoring/prometheus/prometheus.yml`:
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']

  - job_name: 'traefik'
    static_configs:
      - targets: ['traefik:8080']

  - job_name: 'backend'
    static_configs:
      - targets: ['backend:8080']
    metrics_path: /metrics
```

## Loki (Logs)

### Log хайлт

Grafana > Explore > Data source: Loki

#### LogQL жишээ

```logql
# Backend logs
{container="sdyn-backend"}

# Error logs
{container="sdyn-backend"} |= "error"

# JSON parse
{container="sdyn-backend"} | json | level="error"

# Rate
rate({container="sdyn-backend"} |= "error" [5m])
```

### Container-аар шүүх

```logql
# Frontend
{container="sdyn-frontend"}

# Keycloak
{container="sdyn-keycloak"}

# PostgreSQL
{container="sdyn-postgres"}

# Traefik
{container="sdyn-traefik"}
```

### Log Dashboard

1. Grafana > Dashboards > New Dashboard
2. Add panel
3. Data source: Loki
4. Query:
```logql
{container=~"sdyn-.*"} | json | line_format "{{.container}}: {{.message}}"
```

## Docker Stats

### CLI-ээр харах
```bash
# Бүх container
docker stats

# Тодорхой container
docker stats sdyn-backend sdyn-frontend

# One-shot
docker stats --no-stream
```

### Resource limits шалгах
```bash
docker compose ps -a
docker inspect sdyn-backend --format='{{.HostConfig.Memory}}'
```

## Health Checks

### Endpoint шалгах
```bash
# Frontend
curl -s https://e-sdy.mn -o /dev/null -w "%{http_code}"

# API
curl -s https://api.e-sdy.mn/health

# Keycloak
curl -s https://auth.e-sdy.mn -o /dev/null -w "%{http_code}"

# Grafana
curl -s https://grafana.e-sdy.mn -o /dev/null -w "%{http_code}"
```

### Container health
```bash
# Бүх container-ийн health
docker compose ps

# Тодорхой container
docker inspect sdyn-backend --format='{{.State.Health.Status}}'
```

### Database шалгах
```bash
# PostgreSQL
docker exec sdyn-postgres pg_isready -U sdyn_user -d sdyn_db

# Redis
docker exec sdyn-redis redis-cli -a $REDIS_PASSWORD ping
```

## Uptime Monitoring

### External monitoring (санал болгох)
- UptimeRobot (https://uptimerobot.com)
- Pingdom
- StatusCake

### Тохируулах endpoint-ууд:
- https://e-sdy.mn (Frontend)
- https://api.e-sdy.mn/health (API)
- https://auth.e-sdy.mn (Keycloak)

## Performance Tuning

### Prometheus retention
```yaml
# docker-compose.yml
prometheus:
  command:
    - '--storage.tsdb.retention.time=30d'
    - '--storage.tsdb.retention.size=10GB'
```

### Loki retention
```yaml
# loki.yml
limits_config:
  retention_period: 720h  # 30 days
```

### Grafana cleanup
```bash
# Old snapshots устгах
docker exec sdyn-grafana grafana-cli admin data-migration cleanup
```

## Troubleshooting

### Prometheus ажиллахгүй
```bash
# Log шалгах
docker compose logs prometheus

# Config шалгах
docker exec sdyn-prometheus promtool check config /etc/prometheus/prometheus.yml
```

### Grafana ажиллахгүй
```bash
# Log шалгах
docker compose logs grafana

# Permission шалгах
ls -la monitoring/grafana/
```

### Loki ажиллахгүй
```bash
# Log шалгах
docker compose logs loki

# Storage шалгах
docker exec sdyn-loki ls -la /loki
```

---
*Баримт бичгийн хувилбар: 1.0*
*Сүүлд шинэчилсэн: 2026-01-26*
