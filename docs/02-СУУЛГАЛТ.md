# СДЗН Платформ - Суулгалтын заавар

## Шаардлага

### Серверийн шаардлага
- **OS**: Ubuntu 22.04 LTS эсвэл түүнээс дээш
- **RAM**: 4GB (8GB санал болгоно)
- **CPU**: 2 core (4 core санал болгоно)
- **Disk**: 50GB+ SSD
- **Network**: Тогтвортой интернэт холболт

### Програм хангамж
- Docker 24.0+
- Docker Compose 2.0+
- Git

## Алхам 1: Серверийн тохиргоо

### 1.1 SSH-ээр холбогдох
```bash
ssh root@206.189.146.159
```

### 1.2 Серверийн setup script ажиллуулах
```bash
cd /home/sdyn/sdyn-platform
chmod +x scripts/setup-server.sh
./scripts/setup-server.sh
```

Энэ script дараах зүйлсийг хийнэ:
- Систем шинэчлэх
- Шаардлагатай package суулгах
- `sdyn` хэрэглэгч үүсгэх
- Firewall тохируулах (UFW)
- Fail2ban идэвхжүүлэх
- Swap memory үүсгэх (4GB)
- Timezone тохируулах (Asia/Ulaanbaatar)
- Docker суулгах
- Docker network үүсгэх

## Алхам 2: Environment тохируулах

### 2.1 .env файл үүсгэх
```bash
cd /home/sdyn/sdyn-platform
cp .env.example .env
nano .env
```

### 2.2 Нууц үг үүсгэх
```bash
# Нууц үг үүсгэх
openssl rand -base64 24
```

### 2.3 .env файлын жишээ
```env
# App
APP_ENV=production
DOMAIN=e-sdy.mn

# PostgreSQL
POSTGRES_DB=sdyn_db
POSTGRES_USER=sdyn_user
POSTGRES_PASSWORD=<НУУЦ_ҮГ>

# Redis
REDIS_PASSWORD=<НУУЦ_ҮГ>

# Keycloak
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=<НУУЦ_ҮГ>
KEYCLOAK_REALM=sdyn
KEYCLOAK_CLIENT_ID=sdyn-web
KEYCLOAK_CLIENT_SECRET=<НУУЦ_ҮГ>

# MinIO
MINIO_ROOT_USER=sdyn_minio_admin
MINIO_ROOT_PASSWORD=<НУУЦ_ҮГ>

# JWT
JWT_SECRET=<НУУЦ_ҮГ>

# Grafana
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=<НУУЦ_ҮГ>
```

## Алхам 3: DNS тохируулах

Дараах DNS record-уудыг үүсгэнэ:

| Record | Type | Value |
|--------|------|-------|
| e-sdy.mn | A | 206.189.146.159 |
| api.e-sdy.mn | A | 206.189.146.159 |
| admin.e-sdy.mn | A | 206.189.146.159 |
| auth.e-sdy.mn | A | 206.189.146.159 |
| grafana.e-sdy.mn | A | 206.189.146.159 |
| minio.e-sdy.mn | A | 206.189.146.159 |
| storage.e-sdy.mn | A | 206.189.146.159 |

## Алхам 4: SSL тохируулах

### 4.1 ACME storage файл үүсгэх
```bash
touch traefik/acme.json
chmod 600 traefik/acme.json
```

Traefik автоматаар Let's Encrypt-ээс SSL сертификат авна.

## Алхам 5: Deploy хийх

### 5.1 Deploy script ажиллуулах
```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

### 5.2 Гараар deploy хийх
```bash
# Docker network үүсгэх (хэрэв байхгүй бол)
docker network create sdyn-network
docker network create traefik-public

# Image татах
docker compose pull

# Image build хийх
docker compose build --no-cache

# Сервисүүд эхлүүлэх
docker compose up -d
```

## Алхам 6: Баталгаажуулалт

### 6.1 Сервисүүдийн статус шалгах
```bash
docker compose ps
```

Бүх сервис `Up` статустай, database-үүд `(healthy)` байх ёстой.

### 6.2 Endpoint шалгах
```bash
# Frontend
curl -I https://e-sdy.mn

# API
curl https://api.e-sdy.mn/health

# Keycloak
curl -I https://auth.e-sdy.mn

# Grafana
curl -I https://grafana.e-sdy.mn
```

### 6.3 Log шалгах
```bash
# Бүх log
docker compose logs -f

# Тодорхой сервисийн log
docker compose logs -f backend
docker compose logs -f frontend
```

## Алхам 7: Keycloak тохируулах

### 7.1 Admin console нэвтрэх
- URL: https://auth.e-sdy.mn/admin/master/console/
- Username: `.env` файлаас `KEYCLOAK_ADMIN`
- Password: `.env` файлаас `KEYCLOAK_ADMIN_PASSWORD`

### 7.2 Realm үүсгэх
CLI ашиглан:
```bash
docker exec sdyn-keycloak /opt/keycloak/bin/kcadm.sh config credentials \
  --server http://localhost:8080 \
  --realm master \
  --user admin \
  --password <PASSWORD>

docker exec sdyn-keycloak /opt/keycloak/bin/kcadm.sh create realms \
  -s realm=sdyn \
  -s enabled=true
```

## Алдааны шийдэл

### Container эхлэхгүй байвал
```bash
# Log шалгах
docker compose logs <service_name>

# Container дахин эхлүүлэх
docker compose restart <service_name>

# Container устгаад дахин үүсгэх
docker compose up -d --force-recreate <service_name>
```

### Database холболтын алдаа
```bash
# PostgreSQL container шалгах
docker exec -it sdyn-postgres psql -U sdyn_user -d sdyn_db

# Redis шалгах
docker exec -it sdyn-redis redis-cli -a $REDIS_PASSWORD ping
```

### SSL сертификат авахгүй байвал
```bash
# ACME log шалгах
docker compose logs traefik | grep -i acme

# acme.json шалгах
cat traefik/acme.json
```

---
*Баримт бичгийн хувилбар: 1.0*
*Сүүлд шинэчилсэн: 2026-01-26*
