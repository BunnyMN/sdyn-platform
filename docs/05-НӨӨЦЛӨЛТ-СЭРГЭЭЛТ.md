# СДЗН Платформ - Нөөцлөлт ба сэргээлт

## Автомат нөөцлөлт

Систем өдөр бүр шөнийн 02:00 цагт автоматаар нөөцлөлт хийнэ.

### Cron тохиргоо
```bash
# Crontab засах
crontab -e

# Нөөцлөлтийн cron нэмэх
0 2 * * * /home/sdyn/sdyn-platform/scripts/backup.sh >> /home/sdyn/logs/backup.log 2>&1
```

### Нөөцлөлтийн script
```bash
#!/bin/bash
# /home/sdyn/sdyn-platform/scripts/backup.sh

BACKUP_DIR="/home/sdyn/backups"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# PostgreSQL нөөцлөх
docker exec sdyn-postgres pg_dumpall -U sdyn_user | gzip > "$BACKUP_DIR/postgres_$DATE.sql.gz"

# MinIO нөөцлөх
docker run --rm \
  --volumes-from sdyn-minio \
  -v "$BACKUP_DIR:/backup" \
  alpine tar czf "/backup/minio_$DATE.tar.gz" /data

# Environment нөөцлөх
tar czf "$BACKUP_DIR/env_$DATE.tar.gz" \
  -C /home/sdyn/sdyn-platform \
  .env traefik/acme.json

# Хуучин нөөцлөлт устгах
find "$BACKUP_DIR" -name "*.gz" -mtime +$RETENTION_DAYS -delete
```

## Гараар нөөцлөлт хийх

### PostgreSQL нөөцлөх
```bash
# Бүх database
docker exec sdyn-postgres pg_dumpall -U sdyn_user > backup_all.sql

# Тодорхой database
docker exec sdyn-postgres pg_dump -U sdyn_user sdyn_db > backup_sdyn.sql

# Шахсан
docker exec sdyn-postgres pg_dump -U sdyn_user sdyn_db | gzip > backup_sdyn.sql.gz
```

### Redis нөөцлөх
```bash
# RDB файл хуулах
docker exec sdyn-redis redis-cli -a $REDIS_PASSWORD SAVE
docker cp sdyn-redis:/data/dump.rdb ./redis_backup.rdb
```

### MinIO нөөцлөх
```bash
# Data volume хуулах
docker run --rm \
  --volumes-from sdyn-minio \
  -v $(pwd):/backup \
  alpine tar cvf /backup/minio_data.tar /data
```

### Docker volumes нөөцлөх
```bash
# Volume жагсаалт
docker volume ls | grep sdyn

# Volume нөөцлөх
docker run --rm \
  -v sdyn-platform_postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar cvf /backup/postgres_volume.tar /data
```

## Сэргээлт

### PostgreSQL сэргээх
```bash
# Бүх database сэргээх
cat backup_all.sql | docker exec -i sdyn-postgres psql -U sdyn_user

# Шахсан файлаас сэргээх
gunzip -c backup_sdyn.sql.gz | docker exec -i sdyn-postgres psql -U sdyn_user -d sdyn_db

# Database устгаад дахин үүсгэх
docker exec sdyn-postgres psql -U sdyn_user -c "DROP DATABASE sdyn_db;"
docker exec sdyn-postgres psql -U sdyn_user -c "CREATE DATABASE sdyn_db;"
gunzip -c backup_sdyn.sql.gz | docker exec -i sdyn-postgres psql -U sdyn_user -d sdyn_db
```

### Redis сэргээх
```bash
# Redis зогсоох
docker compose stop redis

# RDB файл хуулах
docker cp redis_backup.rdb sdyn-redis:/data/dump.rdb

# Redis эхлүүлэх
docker compose start redis
```

### MinIO сэргээх
```bash
# MinIO зогсоох
docker compose stop minio

# Data сэргээх
docker run --rm \
  --volumes-from sdyn-minio \
  -v $(pwd):/backup \
  alpine tar xvf /backup/minio_data.tar

# MinIO эхлүүлэх
docker compose start minio
```

### Бүрэн систем сэргээх

1. **Docker сервисүүд зогсоох**
```bash
docker compose down
```

2. **Volumes устгах (анхааруулга: бүх data устна!)**
```bash
docker volume rm sdyn-platform_postgres_data
docker volume rm sdyn-platform_redis_data
docker volume rm sdyn-platform_minio_data
```

3. **Шинээр volumes үүсгэх**
```bash
docker compose up -d postgres redis minio
sleep 10
```

4. **Нөөцлөлтөөс сэргээх**
```bash
# PostgreSQL
gunzip -c backups/postgres_YYYYMMDD.sql.gz | docker exec -i sdyn-postgres psql -U sdyn_user

# MinIO
docker run --rm \
  --volumes-from sdyn-minio \
  -v /home/sdyn/backups:/backup \
  alpine tar xzf /backup/minio_YYYYMMDD.tar.gz

# Environment
tar xzf backups/env_YYYYMMDD.tar.gz -C /home/sdyn/sdyn-platform
```

5. **Бүх сервис эхлүүлэх**
```bash
docker compose up -d
```

## Алсын нөөцлөлт

### AWS S3 руу нөөцлөх
```bash
# AWS CLI суулгах
apt install awscli

# Тохиргоо
aws configure

# Нөөцлөлт илгээх
aws s3 sync /home/sdyn/backups s3://your-bucket/sdyn-backups/
```

### Rclone ашиглах
```bash
# Rclone суулгах
curl https://rclone.org/install.sh | sudo bash

# Тохиргоо
rclone config

# Нөөцлөлт илгээх
rclone sync /home/sdyn/backups remote:sdyn-backups/
```

### Rsync ашиглах
```bash
# Өөр сервер рүү
rsync -avz /home/sdyn/backups/ user@backup-server:/backups/sdyn/
```

## Нөөцлөлтийн хяналт

### Нөөцлөлтийн log шалгах
```bash
tail -f /home/sdyn/logs/backup.log
```

### Нөөцлөлтийн хэмжээ шалгах
```bash
du -sh /home/sdyn/backups/*
```

### Сүүлийн нөөцлөлт шалгах
```bash
ls -lah /home/sdyn/backups/ | tail -10
```

## Disaster Recovery

### Шинэ сервер дээр сэргээх

1. **Шинэ сервер бэлтгэх**
```bash
./scripts/setup-server.sh
```

2. **Төслийн файлууд хуулах**
```bash
scp -r /home/sdyn/sdyn-platform user@new-server:/home/sdyn/
```

3. **Нөөцлөлт хуулах**
```bash
scp -r /home/sdyn/backups user@new-server:/home/sdyn/
```

4. **DNS шинэчлэх**
Бүх A record-ийг шинэ серверийн IP руу чиглүүлэх

5. **Сервис эхлүүлж сэргээх**
```bash
cd /home/sdyn/sdyn-platform
docker compose up -d
# Нөөцлөлтөөс сэргээх...
```

## Checklist

### Өдөр бүр
- [ ] Автомат нөөцлөлт амжилттай болсон эсэх

### 7 хоног тутам
- [ ] Нөөцлөлтийн хэмжээ шалгах
- [ ] Алсын нөөцлөлт амжилттай болсон эсэх

### Сар бүр
- [ ] Сэргээлтийн тест хийх
- [ ] Хуучин нөөцлөлт устгах

---
*Баримт бичгийн хувилбар: 1.0*
*Сүүлд шинэчилсэн: 2026-01-26*
