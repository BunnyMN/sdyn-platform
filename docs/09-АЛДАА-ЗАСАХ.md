# СДЗН Платформ - Алдаа засах гарын авлага

## Ерөнхий оношлогоо

### Container статус шалгах
```bash
# Бүх container харах
docker compose ps

# Ажиллахгүй байгаа container
docker compose ps | grep -v "running\|healthy"

# Container restart хийх
docker compose restart <service_name>
```

### Log шалгах
```bash
# Бүх сервисийн log
docker compose logs

# Тодорхой сервисийн log
docker compose logs backend
docker compose logs frontend
docker compose logs keycloak

# Сүүлийн 100 мөр, real-time
docker compose logs -f --tail 100 backend
```

### Resource хэрэглээ
```bash
# Docker stats
docker stats --no-stream

# Системийн resource
htop
free -h
df -h
```

---

## Frontend алдаанууд

### Хуудас ачаалагдахгүй

**Шалтгаан**: Container ажиллахгүй эсвэл build алдаа
```bash
# Log шалгах
docker compose logs frontend

# Rebuild хийх
docker compose build --no-cache frontend
docker compose up -d frontend
```

### CSS ажиллахгүй

**Шалтгаан**: Tailwind CSS build алдаа
```bash
# Container дотор шалгах
docker exec -it sdyn-frontend sh
cat /app/.next/static/css/*.css | head -50

# Rebuild
docker compose build --no-cache frontend
```

### API холболт алдаа

**Шалтгаан**: CORS эсвэл network алдаа
```bash
# Backend health шалгах
curl https://api.e-sdy.mn/health

# CORS header шалгах
curl -I -X OPTIONS https://api.e-sdy.mn/api/v1/members \
  -H "Origin: https://e-sdy.mn" \
  -H "Access-Control-Request-Method: GET"
```

---

## Backend алдаанууд

### Container unhealthy

**Шалтгаан**: Healthcheck амжилтгүй
```bash
# Health endpoint шалгах
docker exec sdyn-backend wget -qO- http://127.0.0.1:8080/health

# Log шалгах
docker compose logs backend | grep -i error
```

### Database холболт алдаа

**Шалтгаан**: PostgreSQL холболт
```bash
# PostgreSQL статус
docker exec sdyn-postgres pg_isready -U sdyn_user -d sdyn_db

# Connection string шалгах
docker exec sdyn-backend env | grep DATABASE

# Backend log
docker compose logs backend | grep -i "database\|postgres\|connection"
```

### JWT Token алдаа

**Шалтгаан**: Keycloak холболт эсвэл token хугацаа
```bash
# Keycloak статус
curl -s https://auth.e-sdy.mn/realms/sdyn/.well-known/openid-configuration | jq .

# Backend Keycloak config
docker exec sdyn-backend env | grep KEYCLOAK
```

---

## Keycloak алдаанууд

### Admin console ачаалагдахгүй

**Шалтгаан**: Container эсвэл database алдаа
```bash
# Log шалгах
docker compose logs keycloak | tail -100

# Database холболт
docker exec sdyn-keycloak /opt/keycloak/bin/kcadm.sh config credentials \
  --server http://localhost:8080 \
  --realm master \
  --user admin
```

### Login ажиллахгүй

**Шалтгаан**: Realm эсвэл client тохиргоо
```bash
# Realm байгаа эсэх
curl -s https://auth.e-sdy.mn/realms/sdyn | jq .realm

# Client шалгах
docker exec sdyn-keycloak /opt/keycloak/bin/kcadm.sh get clients -r sdyn
```

### Redirect URI алдаа

**Шалтгаан**: Valid Redirect URIs буруу
1. Keycloak Admin Console руу орох
2. Clients > sdyn-web
3. Valid Redirect URIs шалгах:
   - `https://e-sdy.mn/*`
   - `https://admin.e-sdy.mn/*`

---

## PostgreSQL алдаанууд

### Connection refused

**Шалтгаан**: PostgreSQL ажиллахгүй
```bash
# Статус шалгах
docker compose ps postgres

# Restart
docker compose restart postgres

# Log шалгах
docker compose logs postgres | tail -50
```

### Authentication failed

**Шалтгаан**: Нууц үг буруу
```bash
# .env файлаас шалгах
grep POSTGRES .env

# Нэвтрэх оролдлого
docker exec -it sdyn-postgres psql -U sdyn_user -d sdyn_db
```

### Database does not exist

**Шалтгаан**: Init script ажиллаагүй
```bash
# Database жагсаалт
docker exec sdyn-postgres psql -U postgres -c "\l"

# Гараар үүсгэх
docker exec sdyn-postgres psql -U postgres -c "CREATE DATABASE sdyn_db OWNER sdyn_user;"
```

### Disk full

**Шалтгаан**: Disk дүүрсэн
```bash
# Disk хэрэглээ
df -h

# PostgreSQL data хэмжээ
docker exec sdyn-postgres du -sh /var/lib/postgresql/data

# Хуучин log устгах
docker exec sdyn-postgres find /var/lib/postgresql/data/log -mtime +7 -delete
```

---

## Redis алдаанууд

### Connection refused

```bash
# Статус
docker compose ps redis

# Ping test
docker exec sdyn-redis redis-cli -a $REDIS_PASSWORD ping
```

### Memory алдаа

```bash
# Memory info
docker exec sdyn-redis redis-cli -a $REDIS_PASSWORD INFO memory

# Keys устгах (production дээр болгоомжтой!)
docker exec sdyn-redis redis-cli -a $REDIS_PASSWORD FLUSHALL
```

---

## Traefik алдаанууд

### SSL сертификат алдаа

**Шалтгаан**: Let's Encrypt лимит эсвэл DNS
```bash
# Log шалгах
docker compose logs traefik | grep -i "acme\|certificate\|error"

# acme.json шалгах
cat traefik/acme.json | jq .
```

### 502 Bad Gateway

**Шалтгаан**: Backend container ажиллахгүй
```bash
# Backend статус
docker compose ps backend

# Traefik routers
curl -s http://localhost:8080/api/http/routers | jq .
```

### 404 Not Found

**Шалтгаан**: Router тохиргоо буруу
```bash
# Traefik config шалгах
docker compose logs traefik | grep -i "router\|rule"

# Labels шалгах
docker inspect sdyn-backend --format='{{json .Config.Labels}}' | jq .
```

---

## MinIO алдаанууд

### Access denied

```bash
# Credentials шалгах
docker exec sdyn-minio env | grep MINIO

# mc config
docker exec sdyn-minio mc alias set local http://localhost:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD
```

### Bucket not found

```bash
# Bucket жагсаалт
docker exec sdyn-minio mc ls local/

# Bucket үүсгэх
docker exec sdyn-minio mc mb local/sdyn-uploads
docker exec sdyn-minio mc policy set public local/sdyn-uploads
```

---

## Network алдаанууд

### Container хоорондын холболт

```bash
# Network жагсаалт
docker network ls

# Network inspect
docker network inspect sdyn-network

# Container network шалгах
docker inspect sdyn-backend --format='{{json .NetworkSettings.Networks}}' | jq .
```

### DNS resolution алдаа

```bash
# Container-аас DNS шалгах
docker exec sdyn-backend nslookup postgres
docker exec sdyn-backend ping -c 3 postgres
```

---

## Performance асуудлууд

### Удаан ачаалагдах

```bash
# Response time шалгах
curl -w "@-" -o /dev/null -s "https://api.e-sdy.mn/health" <<'EOF'
     time_namelookup:  %{time_namelookup}s\n
        time_connect:  %{time_connect}s\n
     time_appconnect:  %{time_appconnect}s\n
    time_pretransfer:  %{time_pretransfer}s\n
       time_redirect:  %{time_redirect}s\n
  time_starttransfer:  %{time_starttransfer}s\n
          time_total:  %{time_total}s\n
EOF

# Database query time
docker exec sdyn-postgres psql -U sdyn_user -d sdyn_db -c "SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;"
```

### Memory leak

```bash
# Container memory
docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}"

# Restart хийх
docker compose restart backend
```

---

## Түгээмэл алдаанууд

### Container exit code 137

**Шалтгаан**: Out of memory (OOM killed)
```bash
# Memory limit нэмэх docker-compose.yml дээр
deploy:
  resources:
    limits:
      memory: 1G
```

### Container exit code 1

**Шалтгаан**: Application error
```bash
# Full log харах
docker compose logs --tail 200 <service>
```

### Permission denied

**Шалтгаан**: Volume permission
```bash
# Permission шалгах
ls -la ./data/

# Permission засах
sudo chown -R 1001:1001 ./data/
```

---

## Сэргээх алхамууд

### Бүх сервис дахин эхлүүлэх
```bash
docker compose down
docker compose up -d
```

### Бүрэн сэргээх
```bash
# Бүх зүйл устгаад дахин эхлүүлэх
docker compose down -v
docker compose up -d

# Нөөцлөлтөөс сэргээх
# (05-НӨӨЦЛӨЛТ-СЭРГЭЭЛТ.md харах)
```

### Emergency: Зөвхөн database
```bash
docker compose up -d postgres redis
docker compose logs -f postgres redis
```

---

## Холбоо барих

Хэрэв дээрх алхамууд тус болоогүй бол:
1. Бүрэн log хадгалах: `docker compose logs > full_logs.txt`
2. System info: `docker info > docker_info.txt`
3. Техникийн багт илгээх

---
*Баримт бичгийн хувилбар: 1.0*
*Сүүлд шинэчилсэн: 2026-01-26*
