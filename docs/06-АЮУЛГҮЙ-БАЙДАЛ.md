# СДЗН Платформ - Аюулгүй байдал

## Серверийн аюулгүй байдал

### Firewall (UFW)

Зөвшөөрөгдсөн портууд:
| Port | Үүрэг |
|------|-------|
| 22 | SSH |
| 80 | HTTP |
| 443 | HTTPS |

```bash
# Статус шалгах
sudo ufw status

# Шинэ дүрэм нэмэх
sudo ufw allow 22/tcp
sudo ufw deny 3306/tcp

# Идэвхжүүлэх
sudo ufw enable
```

### Fail2ban

SSH brute-force халдлагаас хамгаална.

```bash
# Статус шалгах
sudo systemctl status fail2ban

# Jail шалгах
sudo fail2ban-client status sshd

# Banned IP харах
sudo fail2ban-client status sshd | grep "Banned IP"

# IP unban хийх
sudo fail2ban-client set sshd unbanip 192.168.1.100
```

### SSH hardening

`/etc/ssh/sshd_config` файлд:
```
PermitRootLogin prohibit-password
PasswordAuthentication no
PubkeyAuthentication yes
MaxAuthTries 3
LoginGraceTime 30
```

Өөрчлөлтийн дараа:
```bash
sudo systemctl restart sshd
```

## Docker аюулгүй байдал

### Non-root хэрэглэгч
Бүх container non-root хэрэглэгчээр ажиллана:
```dockerfile
RUN adduser -u 1001 -S appuser
USER appuser
```

### Read-only mount
```yaml
volumes:
  - ./config:/etc/app/config:ro
```

### Resource limits
```yaml
deploy:
  resources:
    limits:
      cpus: '0.50'
      memory: 512M
```

### Network isolation
```yaml
networks:
  - internal  # Гадаад хандалтгүй
  - traefik-public  # Traefik-ийн хандалттай
```

## Нууц үгийн удирдлага

### Хүчтэй нууц үг үүсгэх
```bash
# 32 тэмдэгттэй
openssl rand -base64 32

# 24 тэмдэгттэй
openssl rand -base64 24
```

### .env файлын хамгаалалт
```bash
# Зөвхөн эзэмшигч унших боломжтой
chmod 600 .env

# Эзэмшигч өөрчлөх
chown sdyn:sdyn .env
```

### Нууц үг шинэчлэх

1. **PostgreSQL**
```bash
# .env файлд шинэ нууц үг
POSTGRES_PASSWORD=new_password

# Container дахин үүсгэх
docker compose up -d --force-recreate postgres
```

2. **Redis**
```bash
REDIS_PASSWORD=new_password
docker compose up -d --force-recreate redis
```

3. **Keycloak Admin**
```bash
KEYCLOAK_ADMIN_PASSWORD=new_password
docker compose up -d --force-recreate keycloak
```

## SSL/TLS

### Let's Encrypt автомат
Traefik автоматаар SSL сертификат авч, шинэчилнэ.

### Сертификат шалгах
```bash
# SSL сертификат харах
openssl s_client -connect e-sdy.mn:443 -servername e-sdy.mn

# Хугацаа шалгах
echo | openssl s_client -connect e-sdy.mn:443 2>/dev/null | openssl x509 -noout -dates
```

### Сертификат дахин авах
```bash
# acme.json устгах
rm traefik/acme.json
touch traefik/acme.json
chmod 600 traefik/acme.json

# Traefik дахин эхлүүлэх
docker compose restart traefik
```

## API аюулгүй байдал

### Rate Limiting
Backend-д rate limiting тохируулсан:
- 100 хүсэлт/минут хэрэглэгч бүрт

### CORS
Зөвхөн зөвшөөрөгдсөн domain-ууд:
- https://e-sdy.mn
- https://admin.e-sdy.mn

### JWT Token
- Access token: 1 цаг
- Refresh token: 7 хоног
- HS256 algorithm

### Input Validation
- Бүх input validate хийгдэнэ
- SQL injection хамгаалалт (Prepared statements)
- XSS хамгаалалт (HTML escape)

## Keycloak аюулгүй байдал

### Admin хандалт хязгаарлах
1. Keycloak Admin Console руу орох
2. Realm Settings > Security Defenses
3. Brute Force Detection идэвхжүүлэх:
   - Max Login Failures: 5
   - Wait Increment: 30 секунд
   - Max Wait: 15 минут

### Password Policy
1. Realm Settings > Authentication > Password Policy
2. Нэмэх:
   - Length: 8
   - Digits: 1
   - Uppercase: 1
   - Special Characters: 1

### Session хязгаарлалт
1. Realm Settings > Tokens
2. SSO Session Idle: 30 минут
3. SSO Session Max: 8 цаг

## Мониторинг, Аудит

### Log хадгалах
```bash
# Docker logs
docker compose logs --since 24h > logs/daily_$(date +%Y%m%d).log

# Шахаж хадгалах
gzip logs/daily_*.log
```

### Grafana alerts
1. Grafana > Alerting > Alert Rules
2. Шинэ alert үүсгэх:
   - CPU > 80%
   - Memory > 85%
   - Disk > 90%
   - Response time > 2s

### Audit log
Backend бүх үйлдлийг `audit_logs` хүснэгтэд бүртгэнэ:
- Хэн
- Хэзээ
- Юу хийсэн
- IP хаяг

## Security Checklist

### Өдөр бүр
- [ ] Failed login оролдлого шалгах
- [ ] Unusual traffic шалгах

### 7 хоног тутам
- [ ] Docker image шинэчлэлт шалгах
- [ ] Log шалгах

### Сар бүр
- [ ] Нууц үг солих
- [ ] SSL сертификат хугацаа шалгах
- [ ] Security patch суулгах

### Улирал бүр
- [ ] Security audit хийх
- [ ] Penetration test хийх
- [ ] Access review хийх

## Халдлагын үед

### 1. Тусгаарлах
```bash
# Серверийн сүлжээ хаах
sudo ufw default deny incoming
sudo ufw allow from YOUR_IP to any port 22
```

### 2. Шалгах
```bash
# Login history
last -20
lastb -20

# Active connections
netstat -tulpn
ss -tulpn

# Running processes
ps aux
top
```

### 3. Log шинжлэх
```bash
# Auth logs
grep "Failed" /var/log/auth.log
grep "Accepted" /var/log/auth.log

# Docker logs
docker compose logs --since 1h
```

### 4. Сэргээх
```bash
# Нууц үг солих
# SSH key солих
# Нөөцлөлтөөс сэргээх
```

### 5. Тайлагнах
- Болсон явдлыг баримтжуулах
- Шалтгааныг тодорхойлох
- Урьдчилан сэргийлэх арга хэмжээ авах

---
*Баримт бичгийн хувилбар: 1.0*
*Сүүлд шинэчилсэн: 2026-01-26*
